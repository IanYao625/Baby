<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ å¯¶è²çš„æ™šé¤</title>
    <style>
        :root { --primary: #f43f5e; --bg-overlay: rgba(255, 255, 255, 0.75); }
        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background: #fdf2f2 no-repeat center center fixed;
            background-size: cover;
            display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; min-height: 100vh;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.05); z-index: -1;
        }
        .card { background: var(--bg-overlay); backdrop-filter: blur(12px); border-radius: 40px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.4); margin-top: 20px; }
        .nav { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(255,228,230,0.6); padding: 5px; border-radius: 20px; }
        .nav-btn { flex: 1; padding: 12px; border-radius: 15px; border: none; cursor: pointer; font-weight: bold; color: #fb7185; background: transparent; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .key-selector { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; font-size: 0.8rem; }
        .key-tag { padding: 4px 12px; border-radius: 10px; background: rgba(0,0,0,0.05); cursor: pointer; border: 1px solid transparent; }
        .key-tag.active { border-color: var(--primary); color: var(--primary); background: #fff1f2; font-weight: bold; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tag-btn { background: white; border: 2px solid #e2e8f0; padding: 8px 15px; border-radius: 12px; cursor: pointer; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .tag-btn.selected { background: #fff1f2; border-color: var(--primary); color: var(--primary); }
        .option-card { background: white; border-radius: 25px; padding: 20px; margin-bottom: 15px; text-align: left; position: relative; border-left: 6px solid #fb7185; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .option-card b { color: #000; font-size: 1.15rem; display: block; margin-bottom: 8px; }
        .btn { border: none; padding: 18px; width: 100%; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .go-btn { background: #000; color: white; }
        .admin-panel { width: 100%; max-width: 450px; margin-top: 30px; background: rgba(0,0,0,0.7); color: white; border-radius: 20px; overflow: hidden; }
        .admin-header { padding: 12px; cursor: pointer; font-size: 0.8rem; text-align: center; }
        .admin-content { padding: 0 20px; max-height: 0; transition: 0.3s; overflow: hidden; }
        .admin-content.open { padding: 15px 20px; max-height: 150px; }
        .admin-input { width: 100%; padding: 10px; border-radius: 10px; border: none; margin-top: 8px; box-sizing: border-box; }
        .footer-ver { font-size: 0.7rem; color: rgba(255,255,255,0.8); margin-top: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .ai-greeting { font-size: 1rem; margin-bottom: 12px; color: #444; text-align: left; line-height: 1.4; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="card">
        <div class="nav">
            <button id="tab1" class="nav-btn active" onclick="switchMode('store')">ğŸª å¯¶è²çš„æ™šé¤</button>
            <button id="tab2" class="nav-btn" onclick="switchMode('chef')">ğŸ‘¨â€ğŸ³ ç§å»šå°å†°ç®±</button>
        </div>

        <div class="key-selector">
            <span id="kt0" class="key-tag active" onclick="selectKey(0)">ğŸ”‘ é‡‘é‘° 1</span>
            <span id="kt1" class="key-tag" onclick="selectKey(1)">ğŸ”‘ é‡‘é‘° 2</span>
        </div>

        <h2 id="title">âœ¨ æ™šé¤æƒ³åƒä»€éº¼ï¼Ÿ</h2>
        <p id="subtitle" style="font-size: 0.85rem; color: #fb7185; font-weight: bold; margin-bottom: 20px;">( ğŸš« ç„¡ç”Ÿèœ / ğŸš« ç„¡ç‰›å¥¶ / ğŸ¯ æ¸›è„‚å„ªé¸ )</p>
        
        <div id="chef-tools" style="display:none;">
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="text" id="newTag" style="flex:1; padding:12px; border-radius:15px; border:1px solid #ddd;" placeholder="æ–°å¢å†°ç®±é£Ÿæ...">
                <button onclick="addNewTag()" style="padding:0 20px; border-radius:15px; background:#000; color:white; border:none; cursor:pointer;">æ–°å¢</button>
            </div>
            <div class="tag-container" id="tagList"></div>
        </div>
        <div id="result-area"></div>
        <button class="btn go-btn" id="goBtn" onclick="askAI()">ğŸš€ å¹«æˆ‘æº–å‚™æ¸…å–®</button>
        <button class="btn" id="drawBtn" style="display:none; background:#f59e0b; color:white;" onclick="startDraw()">ğŸ¯ å‘½é‹è½‰ç›¤ï¼šæŠ½ä¸€å€‹ï¼</button>
        <button class="btn" id="resetBtn" style="display:none; background:white; color:#000; border:1px solid #000;" onclick="resetUI()">â¬…ï¸ é‡æ–°æŒ‘é¸</button>
    </div>

    <div class="admin-panel">
        <div class="admin-header" onclick="toggleAdmin()">âš™ï¸ è¨­å®šä¸­å¿ƒ</div>
        <div id="adminContent" class="admin-content">
            <input type="text" id="bgUrl" class="admin-input" placeholder="è²¼ä¸ŠèƒŒæ™¯é€£çµ..." onchange="saveAndApplyBg(this.value)">
        </div>
    </div>
    <div class="footer-ver">å¯¶è²çš„æ™šé¤ v11.2.2 | åš´æ ¼ 2.5/3.0 ç‰ˆ</div>

<script>
    let mode = 'store';
    let currentKeyIdx = 0; 
    let savedFridge = localStorage.getItem('my_fridge_data');
    let myFridge = savedFridge ? JSON.parse(savedFridge) : ['é›è›‹', 'é›èƒ¸è‚‰', 'é¯›é­š', 'è±†è…', 'èµ·å¸'];
    let selectedTags = [];
    let storeResultHTML = "";
    let chefResultHTML = "";

    const KEYS = [
        "AIzaSyBpW9OBq7lr_CPauCfsZi2TACR2nRr-I_4",
        "AIzaSyB4ZlvsRRVP6pSFNmDfqvSjtUhKG3atl2w"
    ];

    // ğŸ”´ åš´æ ¼é–å®šï¼šçµ•å°ä¸å‡ºç¾ä»»ä½• 1.5 ç‰ˆæœ¬
    const MODELS = [
        "gemini-2.5-flash",
        "gemini-2.5-flash-lite",
        "gemini-3-flash"
    ];

    function selectKey(idx) {
        currentKeyIdx = idx;
        document.getElementById('kt0').className = idx === 0 ? 'key-tag active' : 'key-tag';
        document.getElementById('kt1').className = idx === 1 ? 'key-tag active' : 'key-tag';
    }

    window.onload = function() {
        const savedBg = localStorage.getItem('dinner_bg_url');
        if (savedBg) applyBgLogic(savedBg);
        if(mode === 'chef') initFridge();
    };

    function toggleAdmin() { document.getElementById('adminContent').classList.toggle('open'); }
    function applyBgLogic(url) {
        if (!url) return;
        let finalUrl = url;
        if (url.includes("drive.google.com")) {
            const idMatch = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
            if (idMatch && idMatch[1]) { finalUrl = `https://drive.google.com/uc?id=${idMatch[1]}`; }
        }
        document.body.style.backgroundImage = "url('" + finalUrl + "')";
    }
    function saveAndApplyBg(url) { if(!url) return; localStorage.setItem('dinner_bg_url', url); applyBgLogic(url); }

    function initFridge() {
        const list = document.getElementById('tagList'); list.innerHTML = "";
        myFridge.forEach(item => {
            const btn = document.createElement('button');
            btn.className = `tag-btn ${selectedTags.includes(item) ? 'selected' : ''}`;
            btn.innerHTML = `<span>${item}</span><span style="color:#ccc; margin-left:8px;" onclick="removeTag(event, '${item}')">âœ•</span>`;
            btn.onclick = () => {
                if(selectedTags.includes(item)) selectedTags = selectedTags.filter(t => t !== item);
                else selectedTags.push(item);
                initFridge();
            };
            list.appendChild(btn);
        });
    }

    function removeTag(e, name) { e.stopPropagation(); myFridge = myFridge.filter(t => t !== name); selectedTags = selectedTags.filter(t => t !== name); localStorage.setItem('my_fridge_data', JSON.stringify(myFridge)); initFridge(); }
    function addNewTag() { const val = document.getElementById('newTag').value.trim(); if(val && !myFridge.includes(val)) { myFridge.push(val); localStorage.setItem('my_fridge_data', JSON.stringify(myFridge)); initFridge(); document.getElementById('newTag').value = ""; } }

    function switchMode(m) {
        mode = m;
        document.getElementById('tab1').className = m==='store'?'nav-btn active':'nav-btn';
        document.getElementById('tab2').className = m==='chef'?'nav-btn active':'nav-btn';
        document.getElementById('chef-tools').style.display = m==='chef'?'block':'none';
        document.getElementById('title').innerText = m==='store'?'âœ¨ æ™šé¤åƒä»€éº¼ï¼Ÿ':'ğŸ‘¨â€ğŸ³ ç§å»šå°å†°ç®±';
        const targetHTML = (m === 'store') ? storeResultHTML : chefResultHTML;
        document.getElementById('result-area').innerHTML = targetHTML;
        if (targetHTML !== "") {
            document.getElementById('goBtn').style.display = "none";
            document.getElementById('resetBtn').style.display = "block";
            document.getElementById('drawBtn').style.display = (m === 'store') ? "block" : "none";
        } else { resetUI(); }
        if(m==='chef') initFridge();
    }

    function resetUI() {
        if (mode === 'store') storeResultHTML = ""; else chefResultHTML = "";
        document.getElementById('result-area').innerHTML = "";
        document.getElementById('drawBtn').style.display = "none";
        document.getElementById('resetBtn').style.display = "none";
        document.getElementById('goBtn').style.display = "block";
    }

    async function askAI() {
        const resArea = document.getElementById('result-area');
        const goBtn = document.getElementById('goBtn');
        resArea.innerHTML = `<p style="text-align:center; padding:30px; color:#fb7185; font-weight:bold; animation: pulse 1.5s infinite;">ğŸ¥£ æ­£åœ¨ä½¿ç”¨ 2.5/3.0 é »é“è¦åŠƒä¸­...</p>`;
        goBtn.disabled = true;

        let prompt = mode === 'store' ? 
            "æ¨è–¦3çµ„è¶…å•†æ¸›è„‚æ™šé¤ï¼Œé«˜è›‹ç™½ã€ç„¡ç”Ÿèœã€ç„¡ç‰›å¥¶ã€‚æ ¼å¼ï¼š<div class='ai-greeting'>ä½ å¥½ï¼</div><div class='option-card'><b>[æ¨è–¦] å“å (ç´„ XXX kcal)</b><p>ğŸ“ æ¸…å–®ï¼š... </p></div>" :
            `é£Ÿæï¼š${selectedTags.join(',')}ã€‚è¦åŠƒ2é“æ¸›è„‚é£Ÿè­œã€‚æ ¼å¼ï¼š<div class='ai-greeting'>ä½ å¥½ï¼</div><div class='option-card'><b>ğŸ´ [ç§å»šæ¨è–¦] å“å</b><p>ğŸ³ æ­¥é©Ÿï¼š... </p></div>`;

        let success = false;
        let logs = "";

        for (let model of MODELS) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${KEYS[currentKeyIdx]}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        let aiText = data.candidates[0].content.parts[0].text.replace(/```html|```/g, "").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        if (mode === 'store') storeResultHTML = aiText; else chefResultHTML = aiText;
                        resArea.innerHTML = aiText;
                        success = true;
                        break; 
                    }
                } else {
                    logs += `[${model}: ${response.status}] `;
                }
            } catch (e) {
                logs += `[${model}: é€£ç·šå¤±æ•—] `;
            }
        }

        if (!success) {
            resArea.innerHTML = `<p style="color:red; text-align:center; padding:20px;">âŒ ç›®å‰æ‰€æœ‰ 2.5/3.0 é »é“ç„¡å›æ‡‰<br><small>${logs}</small><br><br>ğŸ’¡ æç¤ºï¼šè«‹æª¢æŸ¥é‡‘é‘°æ˜¯å¦æœ‰åœ¨ Google AI Studio å•Ÿç”¨ï¼Œæˆ–å˜—è©¦åˆ‡æ›é‡‘é‘°ã€‚</p>`;
        } else {
            if(mode === 'store') document.getElementById('drawBtn').style.display = "block";
            goBtn.style.display = "none";
            document.getElementById('resetBtn').style.display = "block";
        }
        goBtn.disabled = false;
    }

    function startDraw() {
        const cards = document.querySelectorAll('.option-card');
        if (cards.length < 1) return;
        let count = 0;
        const timer = setInterval(() => {
            cards.forEach(c => { c.style.borderColor = "#ddd"; c.style.background = "white"; });
            cards[count % cards.length].style.borderColor = "#fb7185";
            if (++count > 12) {
                clearInterval(timer);
                cards.forEach(c => { c.style.borderColor = "#ddd"; c.style.background = "white"; });
                let winner = cards[Math.floor(Math.random() * cards.length)];
                winner.style.borderColor = "#f59e0b"; winner.style.background = "#fffbeb";
                winner.scrollIntoView({behavior: "smooth"});
            }
        }, 120);
    }
</script>
</body>
</html>
