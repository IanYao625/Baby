<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶è²ç˜¦èº«è¨ˆåŠƒ - å®Œç¾æ•´åˆç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ff6b6b; --success: #51cf66; --bg: #f8f9fa; --text: #343a40; --rule-head: #343a40; --rule-text: #343a40; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: 0.3s; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1000px; margin: 0 auto; }
        .left-column { flex: 1; min-width: 320px; max-width: 450px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; position: relative; }
        .stat-box { text-align: center; padding: 12px; background: #f8f9fa; border-radius: 15px; }
        .stat-value { font-size: 1.3rem; font-weight: 800; display: block; margin-top: 5px; }
        .rule-card { background: #fff; border-left: 6px solid var(--primary); padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        .red-text { color: #e03131; font-weight: bold; text-decoration: underline; }
        
        #ruleHead { color: var(--rule-head); margin: 0 0 15px 0; }
        #ruleList { color: var(--rule-text); padding-left: 20px; line-height: 2; font-size: 1.05rem; list-style-type: decimal; }
        
        .day-dot { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; background: white; }
        .day-dot.success { background-color: var(--success); border-color: var(--success); color: white; }
        .day-dot.cheat { background-color: var(--primary); border-color: var(--primary); color: white; }
        
        button { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        
        .note-toggle { font-size: 0.85rem; color: #868e96; cursor: pointer; text-align: center; margin-top: 15px; text-decoration: underline; }
        .note-content { display: none; margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; }
        textarea { width: 100%; height: 60px; border: 1px solid #eee; border-radius: 10px; padding: 10px; box-sizing: border-box; font-size: 0.9rem; resize: none; }
        
        #adminView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .admin-section { background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .admin-label { font-weight: bold; display: block; margin-top: 15px; margin-bottom: 5px; color: #555; font-size: 0.9rem; }
        .admin-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; }
        
        .admin-collapsible-btn { background: #343a40; color: white; width: 100%; text-align: left; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .admin-collapsible-content { display: none; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 0 0 10px 10px; }
    </style>
</head>
<body>

    <div id="userView" class="main-container">
        <div class="left-column">
            <div class="card">
                <h1 style="color:var(--primary); text-align:center; margin:0 0 15px 0;">ğŸ« ç˜¦èº«é¦¬ç”²ç·šè¨ˆåŠƒ</h1>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="stat-box"><span>æœˆåº•é è¨ˆé ˜å–</span><span class="stat-value" id="totalBonus" style="color:var(--success)">$0</span></div>
                    <div class="stat-box"><span>æœ¬æœˆç´¯è¨ˆç½°æ¬¾</span><span class="stat-value" id="totalFine" style="color:var(--primary)">$0</span></div>
                </div>
            </div>
            <div id="app">è³‡æ–™åŒæ­¥ä¸­...</div>
            <button onclick="processSettlement()" style="background:var(--primary); color:white; width:100%; padding:18px; font-size:1.1rem; border-radius:18px; box-shadow: 0 10px 20px rgba(255,107,107,0.2);">ğŸ çµç®—æœ¬æœˆçé‡‘</button>
            <div id="settleResult" style="display:none; margin-top:20px; padding:20px; border-radius:15px; text-align:center; font-weight:bold;"></div>
            <button style="background:none; border:1px solid #eee; color:#ccc; margin:50px auto; display:block; padding:8px 20px;" onclick="checkAdmin()">ğŸ”’ é€²å…¥ç®¡ç†ä¸­å¿ƒ</button>
        </div>
        <div class="right-column" style="flex: 0.8; min-width: 300px;">
            <div class="rule-card">
                <h2 id="ruleHead">ğŸ“œ æ¸›è‚¥ä½œæˆ°å®ˆå‰‡</h2>
                <ul id="ruleList"></ul>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <p style="font-size: 0.85rem; color: #666; line-height:1.6;">
                    ğŸ’¡ æç¤ºï¼š<br>
                    - æ¯é€±æ—¥ç‚ºæ”¾ç¸±æ—¥ï¼Œå¯æš«åœç´€éŒ„ã€‚<br>
                    - å·åƒä¸‰æ¬¡è©²é€±çé‡‘å³å¤±æ•ˆã€‚<br>
                    - é»æ“Šã€Œâœ… ä»Šå¤©å®Œæˆã€é¡¯ç¤ºç¶ ç‡ˆã€‚<br>
                    - é»æ“Šã€ŒğŸš¨ æŠ“åˆ°å·åƒã€ç½°æ¬¾ 100 å…ƒã€‚
                </p>
            </div>
        </div>
    </div>

    <div id="adminView">
        <div style="max-width:600px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h2 style="margin:0;">ğŸ› ï¸ ç³»çµ±ç®¡ç†æ§åˆ¶å°</h2>
                <button onclick="exitAdmin()" style="background:#eee; color:#666;">é—œé–‰è¦–çª—</button>
            </div>
            
            <div class="admin-section">
                <b style="color:var(--primary)">ğŸ¨ è¦–è¦ºè‰²å½©è¨­å®š</b>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label class="admin-label">ä¸»é¡Œé¡è‰²</label><input type="color" id="colorPrimary" class="admin-input"></div>
                    <div><label class="admin-label">ç¶²é èƒŒæ™¯è‰²</label><input type="color" id="colorBg" class="admin-input"></div>
                    <div><label class="admin-label">å®ˆå‰‡æ¨™é¡Œé¡è‰²</label><input type="color" id="colorRuleHead" class="admin-input"></div>
                    <div><label class="admin-label">å®ˆå‰‡å…§æ–‡é¡è‰²</label><input type="color" id="colorRuleText" class="admin-input"></div>
                </div>
            </div>

            <div class="admin-section">
                <b style="color:var(--primary)">ğŸ“ å…§å®¹èˆ‡å®‰å…¨ç®¡ç†</b>
                <label class="admin-label">æ¸›è‚¥å®ˆå‰‡ (æ¯è¡Œä¸€æ¢):</label>
                <textarea id="editRules" class="admin-input" style="height:120px;"></textarea>
                
                <label class="admin-label">ä¿®æ”¹ç®¡ç†å¯†ç¢¼:</label>
                <input type="text" id="editPw" class="admin-input">
                
                <label class="admin-label">å¯†ç¢¼æç¤ºæ–‡å­—:</label>
                <input type="text" id="editHint" class="admin-input">
                
                <label class="admin-label">æ¯é€±å…¨å‹¤çé‡‘ (NT$):</label>
                <input type="number" id="editBonus" class="admin-input">
            </div>

            <div class="admin-section">
                <button class="admin-collapsible-btn" onclick="toggleAdminWeeks()">
                    <span id="adminWeekTitle">ğŸ“… é€±æœŸé€±æ•¸ç®¡ç†</span>
                    <span id="adminChevron">â–¼</span>
                </button>
                <div id="adminWeekContent" class="admin-collapsible-content">
                    <div id="weekManagerItems"></div>
                    <button onclick="addNewWeek()" style="background:var(--success); color:white; width:100%; margin-top:15px; border-radius:10px;">â• æ–°å¢ä¸€é€±è¨ˆç•«</button>
                </div>
            </div>

            <button onclick="saveAdminSettings()" style="background:var(--primary); color:white; width:100%; padding:20px; font-size:1.2rem; border-radius:15px; margin-top:20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒæ›´æ–°</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU",
            authDomain: "babyhan-11286.firebaseapp.com",
            databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com",
            projectId: "babyhan-11286",
            storageBucket: "babyhan-11286.firebasestorage.app",
            messagingSenderId: "972062726412",
            appId: "1:972062726412:web:ef33e8cfb60305f388d129"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('dietData_FinalV1');

        let data = {
            theme: { primary: "#ff6b6b", bg: "#f8f9fa", ruleHead: "#343a40", ruleText: "#343a40" },
            rules: ["æ—©é¤è¦åƒçš„å¥åº·ã€‚", "ä¸­é¤å¯ä»¥åƒé£½ï¼Œä½†ä¸èƒ½å¤ªå¤šã€‚", "åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾ã€‚", "æ™šé¤å¿…é ˆè¦åƒï¼Œä½†è¦åƒå¥åº·ã€‚"],
            weekBonus: 1000, password: "520", pwHint: "0520", totalFine: 0, settled: false,
            weeks: [
                { cheats: 0, failed: false, dateRange: "1/19 - 1/25", note: "", history: [] },
                { cheats: 0, failed: false, dateRange: "1/26 - 2/1", note: "", history: [] },
                { cheats: 0, failed: false, dateRange: "2/2 - 2/8", note: "", history: [] },
                { cheats: 0, failed: false, dateRange: "2/9 - 2/15", history: [] }
            ]
        };

        db.on('value', (s) => { if(s.val()) { data = s.val(); applyTheme(); render(); } else { db.set(data); } });

        function applyTheme() {
            const root = document.documentElement;
            root.style.setProperty('--primary', data.theme.primary);
            root.style.setProperty('--bg', data.theme.bg);
            root.style.setProperty('--rule-head', data.theme.ruleHead);
            root.style.setProperty('--rule-text', data.theme.ruleText);
        }

        function render() {
            // æ¸²æŸ“å®ˆå‰‡ï¼Œè™•ç†ç‰¹å®šæ–‡å­—æ¨™ç´…
            document.getElementById('ruleList').innerHTML = data.rules.map(r => {
                let text = r.replace("åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾", '<span class="red-text">åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾</span>')
                            .replace("æ™šé¤", '<span class="red-text">æ™šé¤</span>');
                return `<li>${text}</li>`;
            }).join('');

            const app = document.getElementById('app'); app.innerHTML = '';
            let currentBonus = 0;

            data.weeks.forEach((week, index) => {
                if (!week.failed) currentBonus += parseInt(data.weekBonus);
                let dots = '';
                for(let i=0; i<7; i++){
                    const status = week.history ? week.history[i] : undefined;
                    let cls = status === 'success' ? 'success' : (status === 'cheat' ? 'cheat' : '');
                    let txt = status === 'success' ? 'âœ“' : (status === 'cheat' ? 'âœ•' : '');
                    dots += `<span class="day-dot ${cls}">${txt}</span>`;
                }
                const card = document.createElement('div'); card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:800; font-size:1.1rem;">ç¬¬ ${index + 1} é€±</span>
                        <span style="color:${week.failed ? 'red' : 'var(--success)'}; font-weight:bold;">${week.failed ? 'ğŸš¨ çé‡‘æ­¸é›¶' : 'ğŸ’° $'+data.weekBonus}</span>
                    </div>
                    <input style="border:none; color:#888; font-size:0.85rem; width:100%; margin:8px 0; background:none;" value="${week.dateRange}" onchange="updateWeekDate(${index}, this.value)">
                    <div style="text-align:center; font-size:0.9rem; color:#666; margin-bottom:12px;">æœ¬é€±é•è¦ï¼š<b style="color:var(--primary)">${week.cheats}</b> / 3</div>
                    <div style="display:flex; justify-content:center; gap:8px;">${dots}</div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button style="flex:1; background:#ebfbee; color:var(--success); border:1px solid var(--success);" onclick="addStep(${index}, 'success')">âœ… å®Œæˆ</button>
                        <button style="flex:1; background:#fff5f5; color:var(--primary); border:1px solid var(--primary);" onclick="addStep(${index}, 'cheat')">ğŸš¨ å·åƒ</button>
                        <button style="flex:0.4; background:#f8f9fa; color:#ccc; font-size:0.7rem;" onclick="resetWeek(${index})">é‡ç½®</button>
                    </div>
                    <div class="note-toggle" onclick="toggleNote(${index})">ğŸ“ é»æ­¤è¨˜éŒ„å‚™è¨»...</div>
                    <div id="note-${index}" class="note-content">
                        <textarea placeholder="ä¾‹å¦‚ï¼šå·åƒäº†ä¸€å£ç‚¸é›..." onchange="updateNote(${index}, this.value)">${week.note || ''}</textarea>
                    </div>
                `;
                app.appendChild(card);
            });
            document.getElementById('totalBonus').innerText = `$${currentBonus.toLocaleString()}`;
            document.getElementById('totalFine').innerText = `$${data.totalFine.toLocaleString()}`;
            document.getElementById('adminWeekTitle').innerText = `ğŸ“… é€±æœŸé€±æ•¸ç®¡ç† (${data.weeks.length} é€±)`;
        }

        function toggleNote(i) {
            const el = document.getElementById(`note-${i}`);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        function toggleAdminWeeks() {
            const el = document.getElementById('adminWeekContent');
            const chev = document.getElementById('adminChevron');
            const isOpen = el.style.display === 'block';
            el.style.display = isOpen ? 'none' : 'block';
            chev.innerText = isOpen ? 'â–¼' : 'â–²';
        }
        function checkAdmin() {
            const pw = prompt(`ç®¡ç†ç™»å…¥\næç¤ºï¼š${data.pwHint}`);
            if(pw === data.password) {
                document.getElementById('userView').style.display = 'none';
                document.getElementById('adminView').style.display = 'block';
                loadAdminData();
            } else if(pw !== null) alert("å¯†ç¢¼éŒ¯èª¤");
        }
        function loadAdminData() {
            document.getElementById('colorPrimary').value = data.theme.primary;
            document.getElementById('colorBg').value = data.theme.bg;
            document.getElementById('colorRuleHead').value = data.theme.ruleHead;
            document.getElementById('colorRuleText').value = data.theme.ruleText;
            document.getElementById('editRules').value = data.rules.join('\n');
            document.getElementById('editBonus').value = data.weekBonus;
            document.getElementById('editPw').value = data.password;
            document.getElementById('editHint').value = data.pwHint;
            refreshWeekManager();
        }
        function refreshWeekManager() {
            const list = document.getElementById('weekManagerItems'); list.innerHTML = '';
            data.weeks.forEach((w, i) => {
                list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; align-items:center;"><span>ç¬¬ ${i+1} é€± (${w.dateRange})</span><button onclick="deleteWeek(${i})" style="color:#ff6b6b; background:none; font-size:0.8rem;">[åˆªé™¤]</button></div>`;
            });
        }
        function saveAdminSettings() {
            data.theme = { primary: document.getElementById('colorPrimary').value, bg: document.getElementById('colorBg').value, ruleHead: document.getElementById('colorRuleHead').value, ruleText: document.getElementById('colorRuleText').value };
            data.rules = document.getElementById('editRules').value.split('\n').filter(r => r.trim() !== "");
            data.weekBonus = document.getElementById('editBonus').value;
            data.password = document.getElementById('editPw').value;
            data.pwHint = document.getElementById('editHint').value;
            db.set(data); alert("âœ… æ‰€æœ‰è®Šæ›´å·²å„²å­˜ï¼"); exitAdmin();
        }
        function exitAdmin() { document.getElementById('adminView').style.display = 'none'; document.getElementById('userView').style.display = 'flex'; }
        function addNewWeek() { data.weeks.push({cheats:0, failed:false, dateRange: "æ–°é€±æ—¥æœŸ", note:"", history:[]}); db.set(data); refreshWeekManager(); }
        function deleteWeek(i) { if(confirm("ç¢ºå®šè¦åˆªé™¤ç¬¬ "+(i+1)+" é€±å—ï¼Ÿ")) { data.weeks.splice(i, 1); db.set(data); refreshWeekManager(); } }
        function addStep(idx, type) {
            if(data.settled) return alert("å·²çµç®—ï¼Œç„¡æ³•å†æ›´æ”¹ã€‚");
            const w = data.weeks[idx];
            if(!w.history) w.history = [];
            if(w.history.length >= 7) return alert("æœ¬é€±ç´€éŒ„å·²æ»¿ã€‚");
            
            if(type === 'cheat') {
                w.cheats++;
                data.totalFine = (data.totalFine || 0) + 100;
                if(w.cheats >= 3) { w.failed = true; alert("ğŸš¨ ç´¯è¨ˆä¸‰æ¬¡é•è¦ï¼Œçé‡‘æ°æ°ï¼"); }
                else { alert("æŠ“åˆ°å·åƒï¼ç½°æ¬¾ 100 å…ƒ ğŸ’°"); }
                w.history.push('cheat');
            } else {
                w.history.push('success');
            }
            db.set(data);
        }
        function resetWeek(i) { if(confirm("ç¢ºå®šé‡ç½®æœ¬é€±æ•¸æ“šï¼Ÿ")) { data.weeks[i] = {cheats:0, failed:false, dateRange:"è¨­å®šæ—¥æœŸ", note:"", history:[]}; db.set(data); } }
        function updateWeekDate(i, v) { data.weeks[i].dateRange = v; db.set(data); }
        function updateNote(i, v) { data.weeks[i].note = v; db.set(data); }
        function processSettlement() { if(confirm("ç¢ºå®šè¦çµç®—æœ¬æœˆçé‡‘å—ï¼Ÿ")) { data.settled = true; db.set(data); } }
    </script>
</body>
</html>