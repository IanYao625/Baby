<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶è²ç˜¦èº«è¨ˆåŠƒ - é›²ç«¯ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ff6b6b; --success: #51cf66; --bg: #f8f9fa; --text: #343a40; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 10px; }
        .stat-value { font-size: 1.2rem; font-weight: bold; display: block; }
        .rule-card { background: #fff; border-left: 5px solid var(--primary); padding: 20px; border-radius: 10px; position: sticky; top: 20px; }
        .day-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; background: white; }
        .day-dot.success { background-color: var(--success); border-color: var(--success); color: white; }
        .day-dot.cheat { background-color: var(--primary); border-color: var(--primary); color: white; }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* ç®¡ç†å“¡å°ˆå€æ¨£å¼ */
        #adminPanel { display: none; background: #343a40; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .admin-input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;}
        .lock-icon { text-align: center; color: #ced4da; cursor: pointer; margin-top: 50px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="main-container">
        <div style="flex: 1; min-width: 320px;">
            <div class="card">
                <h1 id="mainTitle">ğŸ« ç˜¦èº«é¦¬ç”²ç·šè¨ˆåŠƒ</h1>
                <div class="dashboard">
                    <div class="stat-box"><span>æœˆåº•é è¨ˆé ˜å–</span><span class="stat-value" id="totalBonus" style="color:var(--success)">NT$ 0</span></div>
                    <div class="stat-box"><span>ç´¯è¨ˆç½°æ¬¾</span><span class="stat-value" id="totalFine" style="color:var(--primary)">NT$ 0</span></div>
                </div>
            </div>
            <div id="app">é€£ç·šä¸­...</div>
        </div>

        <div style="flex: 0.8; min-width: 300px;">
            <div class="rule-card">
                <h2 id="ruleTitle">ğŸ“œ æ¸›è‚¥ä½œæˆ°å®ˆå‰‡</h2>
                <ul id="ruleList" style="padding-left: 20px; line-height: 2;"></ul>
            </div>
            
            <div class="lock-icon" onclick="openAdmin()">ğŸ”’ ç®¡ç†å“¡ç™»å…¥</div>
            
            <div id="adminPanel">
                <h3>ğŸ› ï¸ ç®¡ç†å“¡æ§åˆ¶å°</h3>
                <p>ä¿®æ”¹è¨ˆç•«è¦å‰‡ (æ¯è¡Œä¸€æ¢):</p>
                <textarea id="editRules" class="admin-input" rows="5"></textarea>
                <p>æ¯é€±çé‡‘é‡‘é¡:</p>
                <input type="number" id="editBonus" class="admin-input">
                <button onclick="saveAdminSettings()" style="background:var(--success); color:white; margin-top:10px;">å„²å­˜ä¸¦ç«‹å³æ›´æ–°ç¶²é </button>
                <button onclick="closeAdmin()" style="background:#666; color:white; margin-top:5px;">é—œé–‰å¾Œå°</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU",
            authDomain: "babyhan-11286.firebaseapp.com",
            databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com",
            projectId: "babyhan-11286",
            storageBucket: "babyhan-11286.firebasestorage.app",
            messagingSenderId: "972062726412",
            appId: "1:972062726412:web:ef33e8cfb60305f388d129"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('dietDataV2');

        let data = {
            rules: ["æ—©é¤è¦åƒçš„å¥åº·", "ä¸­é¤å¯ä»¥åƒé£½ï¼Œä½†ä¸èƒ½å¤ªå¤š", "åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾", "æ™šé¤å¿…é ˆè¦åƒï¼Œä½†è¦åƒå¥åº·"],
            weekBonus: 1000,
            password: "520", // é è¨­å¯†ç¢¼
            pwHint: "æˆ‘å€‘äº¤å¾€çš„æœˆä»½åŠ ä¸Šæ—¥æœŸ (ä¾‹: 0520)",
            totalFine: 0,
            weeks: Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "è¨­å®šæ—¥æœŸ", history: [] }))
        };

        db.on('value', (s) => { if(s.val()) { data = s.val(); render(); } else { db.set(data); } });

        function render() {
            const list = document.getElementById('ruleList');
            list.innerHTML = data.rules.map(r => `<li>${r}</li>`).join('');
            
            const app = document.getElementById('app');
            app.innerHTML = '';
            let currentBonus = 0;

            data.weeks.forEach((week, index) => {
                if (!week.failed) currentBonus += parseInt(data.weekBonus);
                let historyDots = '';
                for(let i=0; i<7; i++) {
                    const status = week.history ? week.history[i] : undefined;
                    let dotClass = '', dotText = '';
                    if(status === 'success') { dotClass = 'success'; dotText = 'âœ“'; }
                    else if(status === 'cheat') { dotClass = 'cheat'; dotText = 'âœ•'; }
                    historyDots += `<span class="day-dot ${dotClass}">${dotText}</span>`;
                }
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>ç¬¬ ${index + 1} é€±</span>
                        <span style="color:${week.failed ? 'red' : 'green'}">$${week.failed?0:data.weekBonus}</span>
                    </div>
                    <input style="border:none; color:gray; width:100%;" value="${week.dateRange}" onchange="updateWeekDate(${index}, this.value)">
                    <div style="margin: 15px 0; display:flex; justify-content:center; gap:5px;">${historyDots}</div>
                    <div class="btn-group">
                        <button style="background:#ebfbee; color:green;" onclick="addStep(${index}, 'success')">âœ… å®Œæˆ</button>
                        <button style="background:#fff5f5; color:red;" onclick="addStep(${index}, 'cheat')">ğŸš¨ å·åƒ</button>
                    </div>
                `;
                app.appendChild(card);
            });
            document.getElementById('totalBonus').innerText = `NT$ ${currentBonus}`;
            document.getElementById('totalFine').innerText = `NT$ ${data.totalFine}`;
        }

        // ç®¡ç†åŠŸèƒ½
        function openAdmin() {
            const pw = prompt(`è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼\næç¤ºï¼š${data.pwHint}`);
            if (pw === data.password) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('editRules').value = data.rules.join('\n');
                document.getElementById('editBonus').value = data.weekBonus;
            } else if (pw !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼å†æƒ³æƒ³çœ‹ï¼Ÿ");
            }
        }

        function saveAdminSettings() {
            data.rules = document.getElementById('editRules').value.split('\n').filter(r => r.trim() !== "");
            data.weekBonus = document.getElementById('editBonus').value;
            db.set(data);
            alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼ç¶²é å·²æ›´æ–°ã€‚");
            closeAdmin();
        }

        function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }
        function addStep(idx, type) {
            const w = data.weeks[idx];
            if(!w.history) w.history = [];
            if(w.history.length >= 7) return;
            if(type === 'cheat') {
                w.cheats++; data.totalFine += 100;
                if(w.cheats >= 3) w.failed = true;
                w.history.push('cheat');
            } else { w.history.push('success'); }
            db.set(data);
        }
        function updateWeekDate(idx, val) { data.weeks[idx].dateRange = val; db.set(data); }
    </script>
</body>
</html>