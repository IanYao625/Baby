<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶è²ç˜¦èº«è¨ˆåŠƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ff6b6b; --success: #51cf66; --bg: #f8f9fa; --text: #343a40; --rule-head: #343a40; --rule-text: #343a40; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1000px; margin: 0 auto; }
        .left-column { flex: 1; min-width: 320px; max-width: 450px; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .stat-box { text-align: center; padding: 12px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; }
        .stat-value { font-size: 1.2rem; font-weight: 800; display: block; margin-top: 5px; }
        .rule-card { background: #fff; border-left: 6px solid var(--primary); padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        .day-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; background: white; }
        .day-dot.success { background-color: var(--success); border-color: var(--success); color: white; }
        .day-dot.cheat { background-color: var(--primary); border-color: var(--primary); color: white; }
        button { padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        textarea { width: 100%; height: 50px; border: 1px solid #eee; border-radius: 8px; margin-top: 10px; padding: 8px; box-sizing: border-box; resize: none; }
        
        #adminView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; overflow-y: auto; padding: 20px; }
        .admin-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .admin-input { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .note-content { display: none; }
    </style>
</head>
<body>

    <div id="userView" class="main-container">
        <div class="left-column">
            <div class="card">
                <h1 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ« å¯¶è²ç˜¦èº«è¨ˆåŠƒ</h1>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stat-box"><span>æœˆåº•é ˜è³çé‡‘</span><span class="stat-value" id="totalBonus" style="color:var(--success)">$0</span></div>
                    <div class="stat-box"><span>æœ¬æœˆç´¯è¨ˆç½°æ¬¾</span><span class="stat-value" id="totalFine" style="color:var(--primary)">$0</span></div>
                </div>
            </div>
            <div id="app">è¼‰å…¥ä¸­...</div>
            <button onclick="processSettlement()" style="background:var(--primary); color:white; width:100%; padding:15px; font-size:1.1rem; border-radius:15px;">ğŸ çµç®—æœ¬æœˆçé‡‘</button>
            <div id="settleResult" style="display:none; margin-top:20px; padding:20px; border-radius:15px; text-align:center; font-weight:bold; white-space:pre-line;"></div>
            <button style="background:none; color:#ccc; margin:30px auto; display:block;" onclick="checkAdmin()">ğŸ”’ ç®¡ç†ä¸­å¿ƒ</button>
        </div>
        <div style="flex: 0.8; min-width: 300px;">
            <div class="rule-card">
                <h2 id="ruleHead">ğŸ“œ æ¸›è‚¥ä½œæˆ°å®ˆå‰‡</h2>
                <ul id="ruleList" style="line-height:2;"></ul>
            </div>
        </div>
    </div>

    <div id="adminView">
        <h2 style="display:flex; justify-content:space-between;">ğŸ› ï¸ ç®¡ç†ä¸­å¿ƒ <button onclick="exitAdmin()" style="background:#eee;">é—œé–‰</button></h2>
        
        <div class="admin-section">
            <b>ğŸ¨ è‰²å½©èˆ‡è¦å‰‡</b>
            <label style="display:block; margin-top:10px;">å®ˆå‰‡ (æ¯è¡Œä¸€æ¢):</label>
            <textarea id="editRules" class="admin-input" style="height:80px;"></textarea>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <label>ä¸»é¡Œè‰² <input type="color" id="colorPrimary" class="admin-input"></label>
                <label>èƒŒæ™¯è‰² <input type="color" id="colorBg" class="admin-input"></label>
            </div>
        </div>

        <div class="admin-section">
            <b>ğŸ”‘ å®‰å…¨èˆ‡çé‡‘</b><br>
            å¯†ç¢¼: <input type="text" id="editPw" class="admin-input">
            æç¤º: <input type="text" id="editHint" class="admin-input">
            é€±çé‡‘: <input type="number" id="editBonus" class="admin-input">
        </div>

        <div class="admin-section">
            <b>ğŸ“… é€±æ•¸ç®¡ç†</b>
            <div id="weekManagerItems" style="margin-top:10px;"></div>
            <button onclick="addNewWeek()" style="background:var(--success); color:white; width:100%; margin-top:10px;">â• æ–°å¢ä¸€é€±</button>
        </div>

        <button onclick="saveAdminSettings()" style="background:var(--primary); color:white; width:100%; padding:15px; font-size:1.1rem; border-radius:10px;">ğŸ’¾ å„²å­˜è¨­å®š</button>
        <button onclick="fullReset()" style="background:#ccc; width:100%; margin-top:10px;">âš ï¸ é‡ç½®æ•´æœˆ (æ–°é–‹å§‹)</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU",
            authDomain: "babyhan-11286.firebaseapp.com",
            databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com",
            projectId: "babyhan-11286",
            storageBucket: "babyhan-11286.firebasestorage.app",
            messagingSenderId: "972062726412",
            appId: "1:972062726412:web:ef33e8cfb60305f388d129"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('dietData_StableV1');

        let data = {
            theme: { primary: "#ff6b6b", bg: "#f8f9fa" },
            rules: ["æ—©é¤åƒå¥åº·", "åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾", "æ™šé¤åƒå¥åº·"],
            weekBonus: 1000, password: "520", pwHint: "0520", totalFine: 0, settled: false,
            weeks: Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "æ—¥æœŸ", note: "", history: [] }))
        };

        db.on('value', (s) => { if(s.val()) { data = s.val(); updateUI(); } else { db.set(data); } });

        function updateUI() {
            document.documentElement.style.setProperty('--primary', data.theme.primary);
            document.documentElement.style.setProperty('--bg', data.theme.bg);
            document.getElementById('ruleList').innerHTML = data.rules.map(r => `<li>${r.replace(/åš´ç¦é£²æ–™ã€ä¸‹åˆèŒ¶ã€é¤…ä¹¾|æ™šé¤/g, '<b style="color:red;text-decoration:underline;">$&</b>')}</li>`).join('');
            
            const app = document.getElementById('app'); app.innerHTML = '';
            let currentBonus = 0;

            data.weeks.forEach((w, i) => {
                if (!w.failed) currentBonus += parseInt(data.weekBonus);
                let dots = '';
                for(let j=0; j<7; j++){
                    const status = w.history ? w.history[j] : undefined;
                    dots += `<span class="day-dot ${status||''}"> ${status==='success'?'âœ“':status==='cheat'?'âœ•':''} </span>`;
                }
                const div = document.createElement('div'); div.className = 'card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>ç¬¬ ${i+1} é€±</span><span style="color:${w.failed?'red':'green'}">${w.failed?'çé‡‘æ­¸é›¶':'é ˜è³ $'+data.weekBonus}</span></div>
                    <input style="border:none; color:#888; font-size:0.8rem; background:none;" value="${w.dateRange}" onchange="updateWeekDate(${i}, this.value)">
                    <div style="text-align:center; font-size:0.9rem; margin:10px 0;">é•è¦ï¼š<b style="color:var(--primary)">${w.cheats}</b> / 3</div>
                    <div style="display:flex; justify-content:center; gap:5px;">${dots}</div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button style="flex:1; background:#ebfbee; color:green;" onclick="addLog(${i}, 'success')">âœ… å®Œæˆ</button>
                        <button style="flex:1; background:#fff5f5; color:red;" onclick="addLog(${i}, 'cheat')">ğŸš¨ å·åƒ</button>
                        <button style="flex:0.3; background:#eee; font-size:0.7rem;" onclick="resetW(${i})">é‡ç½®</button>
                    </div>
                    <div onclick="this.nextElementSibling.style.display='block'" style="cursor:pointer; color:#999; text-align:center; font-size:0.8rem; margin-top:10px;">ğŸ“ å±•é–‹å‚™è¨»</div>
                    <textarea class="note-content" onchange="updateNote(${i}, this.value)">${w.note||''}</textarea>
                `;
                app.appendChild(div);
            });
            document.getElementById('totalBonus').innerText = `$${currentBonus}`;
            document.getElementById('totalFine').innerText = `$${data.totalFine}`;
            
            const res = document.getElementById('settleResult');
            if(data.settled) {
                res.style.display = 'block';
                const win = currentBonus > 0;
                res.style.background = win ? '#d3f9d8' : '#ffe3e3';
                res.innerText = win ? `ğŸ‰ æœ€çµ‚çé‡‘ï¼šNT$ ${currentBonus} \n ğŸ’– æ­å–œç˜¦èº«æˆåŠŸï¼å»æ‰¾æœ•é ˜è³ï¼` : `ğŸ‘º å…¨è»è¦†æ²’ \n è¨˜å¾—å»ç¹³æ¸…ç½°æ¬¾ï¼`;
            } else { res.style.display = 'none'; }
        }

        function addLog(idx, type) {
            if(data.settled) return;
            const w = data.weeks[idx]; if(!w.history) w.history = []; if(w.history.length >= 7) return;
            if(type === 'cheat') {
                w.cheats++; data.totalFine += 100;
                if(w.cheats >= 3) w.failed = true;
            }
            w.history.push(type); db.set(data);
        }

        function resetW(i) {
            if(confirm("é‡ç½®è©²é€±ï¼Ÿç½°æ¬¾å°‡æ‰£å›ã€‚")) {
                data.totalFine = Math.max(0, data.totalFine - (data.weeks[i].cheats * 100));
                data.weeks[i] = { cheats: 0, failed: false, dateRange: "è¨­å®šæ—¥æœŸ", note: "", history: [] };
                db.set(data);
            }
        }

        function checkAdmin() { if(prompt(`æç¤ºï¼š${data.pwHint}`) === data.password) { document.getElementById('userView').style.display='none'; document.getElementById('adminView').style.display='block'; loadAdmin(); } }
        function loadAdmin() {
            document.getElementById('editRules').value = data.rules.join('\n');
            document.getElementById('colorPrimary').value = data.theme.primary;
            document.getElementById('colorBg').value = data.theme.bg;
            document.getElementById('editPw').value = data.password;
            document.getElementById('editHint').value = data.pwHint;
            document.getElementById('editBonus').value = data.weekBonus;
            const mgr = document.getElementById('weekManagerItems'); mgr.innerHTML = '';
            data.weeks.forEach((w, i) => { mgr.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>ç¬¬ ${i+1} é€± (${w.dateRange})</span> <button onclick="delWeek(${i})" style="color:red;">åˆªé™¤</button></div>`; });
        }
        function saveAdminSettings() {
            data.rules = document.getElementById('editRules').value.split('\n');
            data.theme = { primary: document.getElementById('colorPrimary').value, bg: document.getElementById('colorBg').value };
            data.password = document.getElementById('editPw').value; data.pwHint = document.getElementById('editHint').value;
            data.weekBonus = document.getElementById('editBonus').value;
            db.set(data); alert("å·²æ›´æ–°ï¼"); exitAdmin();
        }
        function fullReset() { if(confirm("ç¢ºå®šé–‹å•Ÿæ–°æœˆä»½ï¼Ÿæ•¸æ“šå°‡æ­¸é›¶ã€‚")) { data.totalFine = 0; data.settled = false; data.weeks = Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "è¨­å®šæ—¥æœŸ", note: "", history: [] })); db.set(data); exitAdmin(); } }
        function exitAdmin() { document.getElementById('adminView').style.display='none'; document.getElementById('userView').style.display='flex'; }
        function addNewWeek() { data.weeks.push({cheats:0, failed:false, dateRange:"æ–°é€±", note:"", history:[]}); db.set(data); loadAdmin(); }
        function delWeek(i) { data.weeks.splice(i,1); db.set(data); loadAdmin(); }
        function updateWeekDate(i, v) { data.weeks[i].dateRange = v; db.set(data); }
        function updateNote(i, v) { data.weeks[i].note = v; db.set(data); }
        function processSettlement() { if(confirm("çµç®—ï¼Ÿ")) { data.settled = true; db.set(data); } }
    </script>
</body>
</html>