<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶è²ç˜¦èº«è¨ˆåŠƒ - å…¨è‡ªè¨‚è‰²å½©ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style id="dynamicTheme">
        :root { --primary: #ff6b6b; --bg: #f8f9fa; --rule-head: #343a40; --rule-text: #343a40; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; transition: 0.3s; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        .rule-card { background: #fff; border-left: 5px solid var(--primary); padding: 20px; border-radius: 10px; position: sticky; top: 20px; }
        /* è¦å‰‡é¡è‰²å¥—ç”¨ */
        #ruleHead { color: var(--rule-head); }
        #ruleList { color: var(--rule-text); padding-left: 20px; line-height: 1.8; }
        
        .day-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; background: white; }
        .day-dot.success { background-color: #51cf66; border-color: #51cf66; color: white; }
        .day-dot.cheat { background-color: var(--primary); border-color: var(--primary); color: white; }
        button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        #adminView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; color: #333; }
        .admin-section { background: #f1f3f5; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .admin-input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .color-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .color-item { display: flex; flex-direction: column; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="userView" class="main-container">
        <div style="flex: 1; min-width: 320px; max-width: 450px;">
            <div class="card">
                <h1>ğŸ« ç˜¦èº«é¦¬ç”²ç·šè¨ˆåŠƒ</h1>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 10px;">
                        <span>æœˆåº•é ˜å–</span><br><span id="totalBonus" style="color:#51cf66; font-weight:bold;">$0</span>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 10px;">
                        <span>ç´¯è¨ˆç½°æ¬¾</span><br><span id="totalFine" style="color:var(--primary); font-weight:bold;">$0</span>
                    </div>
                </div>
            </div>
            <div id="app">é€£ç·šä¸­...</div>
            <button onclick="processSettlement()" style="background:var(--primary); color:white; width:100%; padding:15px; font-size:1.1rem; border-radius:15px;">ğŸ çµç®—çé‡‘</button>
            <div id="settleResult" style="display:none; margin-top:15px; padding:15px; border-radius:10px; text-align:center; font-weight:bold;"></div>
            <button style="background:none; border:1px solid #ccc; color:#999; margin:40px auto; display:block;" onclick="checkAdmin()">ğŸ”’ ç³»çµ±è¨­å®š</button>
        </div>

        <div style="flex: 0.8; min-width: 300px;">
            <div class="rule-card">
                <h2 id="ruleHead">ğŸ“œ æ¸›è‚¥ä½œæˆ°å®ˆå‰‡</h2>
                <ul id="ruleList"></ul>
            </div>
        </div>
    </div>

    <div id="adminView">
        <h2>ğŸ› ï¸ ä»‹é¢è‰²å½©èˆ‡å…§å®¹ç®¡ç†</h2>
        
        <div class="admin-section">
            <label><b>ğŸ¨ é¡è‰²è‡ªè¨‚:</b></label>
            <div class="color-group">
                <div class="color-item"><label>ä¸»é¡Œè‰² (æŒ‰éˆ•/è­¦ç¤º)</label><input type="color" id="colorPrimary"></div>
                <div class="color-item"><label>ç¶²é èƒŒæ™¯</label><input type="color" id="colorBg"></div>
                <div class="color-item"><label>è¦å‰‡æ¨™é¡Œé¡è‰²</label><input type="color" id="colorRuleHead"></div>
                <div class="color-item"><label>è¦å‰‡æ–‡å­—é¡è‰²</label><input type="color" id="colorRuleText"></div>
            </div>
        </div>

        <div class="admin-section">
            <label><b>ğŸ“ æ–‡å­—èˆ‡è¦å‰‡:</b></label>
            <textarea id="editRules" class="admin-input" style="height:80px;" placeholder="æ¯ä¸€è¡Œä»£è¡¨ä¸€æ¢è¦å‰‡"></textarea>
            <input type="text" id="editPw" class="admin-input" placeholder="ç™»å…¥å¯†ç¢¼">
            <input type="text" id="editHint" class="admin-input" placeholder="å¯†ç¢¼æç¤º">
            <input type="number" id="editBonus" class="admin-input" placeholder="æ¯é€±çé‡‘">
        </div>

        <div class="admin-section">
            <label><b>ğŸ“… é€±æœŸç®¡ç†:</b></label>
            <div id="weekManagerItems" style="margin:10px 0;"></div>
            <button onclick="addNewWeek()" style="background:#4dabf7; color:white; width:100%;">â• æ–°å¢é€±æ•¸</button>
        </div>

        <button onclick="saveAdminSettings()" style="background:#51cf66; color:white; width:100%; padding:15px; font-size:1.1rem; border-radius:10px;">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
        <button onclick="exitAdmin()" style="background:#999; color:white; width:100%; margin-top:10px;">è¿”å›å‰å°</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU",
            authDomain: "babyhan-11286.firebaseapp.com",
            databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com",
            projectId: "babyhan-11286",
            storageBucket: "babyhan-11286.firebasestorage.app",
            messagingSenderId: "972062726412",
            appId: "1:972062726412:web:ef33e8cfb60305f388d129"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('dietDataV7');

        let data = {
            theme: { primary: "#ff6b6b", bg: "#f8f9fa", ruleHead: "#343a40", ruleText: "#343a40" },
            rules: ["æ—©é¤è¦åƒçš„å¥åº·", "æ™šé¤è¦åƒå¥åº·"],
            weekBonus: 1000, password: "520", pwHint: "0520", totalFine: 0, settled: false,
            weeks: Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "æ—¥æœŸ", note: "", history: [] }))
        };

        db.on('value', (s) => { if(s.val()) { data = s.val(); applyTheme(); render(); } else { db.set(data); } });

        function applyTheme() {
            const root = document.documentElement;
            root.style.setProperty('--primary', data.theme.primary);
            root.style.setProperty('--bg', data.theme.bg);
            root.style.setProperty('--rule-head', data.theme.ruleHead || "#343a40");
            root.style.setProperty('--rule-text', data.theme.ruleText || "#343a40");
        }

        function render() {
            document.getElementById('ruleList').innerHTML = data.rules.map(r => `<li>${r}</li>`).join('');
            const app = document.getElementById('app'); app.innerHTML = '';
            let currentBonus = 0;
            data.weeks.forEach((week, index) => {
                if (!week.failed) currentBonus += parseInt(data.weekBonus);
                let historyDots = '';
                for(let i=0; i<7; i++){
                    const status = week.history ? week.history[i] : undefined;
                    let dotClass = status === 'success' ? 'success' : (status === 'cheat' ? 'cheat' : '');
                    let dotText = status === 'success' ? 'âœ“' : (status === 'cheat' ? 'âœ•' : '');
                    historyDots += `<span class="day-dot ${dotClass}">${dotText}</span>`;
                }
                const card = document.createElement('div'); card.className = 'card';
                card.innerHTML = `<div style="display:flex; justify-content:space-between; font-weight:bold;"><span>ç¬¬ ${index + 1} é€±</span><span style="color:${week.failed ? 'red' : 'green'}">$${week.failed?0:data.weekBonus}</span></div><input style="border:none; color:gray; font-size:0.8rem; width:100%; margin:5px 0;" value="${week.dateRange}" onchange="updateWeekDate(${index}, this.value)"><div style="margin: 10px 0; display:flex; justify-content:center; gap:5px;">${historyDots}</div><div style="display:flex; gap:5px;"><button style="flex:1; background:#ebfbee; color:green;" onclick="addStep(${index}, 'success')">âœ… å®Œæˆ</button><button style="flex:1; background:#fff5f5; color:red;" onclick="addStep(${index}, 'cheat')">ğŸš¨ å·åƒ</button></div><textarea onchange="updateNote(${index}, this.value)">${week.note || ''}</textarea>`;
                app.appendChild(card);
            });
            document.getElementById('totalBonus').innerText = `$${currentBonus}`;
            document.getElementById('totalFine').innerText = `$${data.totalFine}`;
        }

        function checkAdmin() {
            const pw = prompt(`æç¤ºï¼š${data.pwHint}`);
            if(pw === data.password) {
                document.getElementById('userView').style.display = 'none';
                document.getElementById('adminView').style.display = 'block';
                document.getElementById('colorPrimary').value = data.theme.primary;
                document.getElementById('colorBg').value = data.theme.bg;
                document.getElementById('colorRuleHead').value = data.theme.ruleHead || "#343a40";
                document.getElementById('colorRuleText').value = data.theme.ruleText || "#343a40";
                document.getElementById('editRules').value = data.rules.join('\n');
                document.getElementById('editBonus').value = data.weekBonus;
                document.getElementById('editPw').value = data.password;
                document.getElementById('editHint').value = data.pwHint;
                refreshWeekManager();
            } else if(pw !== null) alert("å¯†ç¢¼éŒ¯èª¤");
        }

        function saveAdminSettings() {
            data.theme = { 
                primary: document.getElementById('colorPrimary').value, 
                bg: document.getElementById('colorBg').value,
                ruleHead: document.getElementById('colorRuleHead').value,
                ruleText: document.getElementById('colorRuleText').value
            };
            data.rules = document.getElementById('editRules').value.split('\n').filter(r => r.trim() !== "");
            data.weekBonus = document.getElementById('editBonus').value;
            data.password = document.getElementById('editPw').value;
            data.pwHint = document.getElementById('editHint').value;
            db.set(data);
            alert("è¨­å®šå·²æ›´æ–°ï¼");
            exitAdmin();
        }

        function exitAdmin() { document.getElementById('adminView').style.display = 'none'; document.getElementById('userView').style.display = 'flex'; }
        function refreshWeekManager() { const list = document.getElementById('weekManagerItems'); list.innerHTML = ''; data.weeks.forEach((w, i) => { list.innerHTML += `<div style="display:flex; justify-content:space-between; background:#fff; padding:8px; margin-bottom:5px; border-radius:5px;"><span>ç¬¬ ${i+1} é€±</span><button onclick="deleteWeek(${i})" style="background:red; color:white; padding:2px 8px; font-size:0.7rem;">åˆªé™¤</button></div>`; }); }
        function addNewWeek() { data.weeks.push({cheats:0, failed:false, dateRange:"æ–°æ—¥æœŸ", note:"", history:[]}); db.set(data); refreshWeekManager(); }
        function deleteWeek(i) { if(confirm("åˆªé™¤ï¼Ÿ")) { data.weeks.splice(i, 1); db.set(data); refreshWeekManager(); } }
        function addStep(idx, type) { const w = data.weeks[idx]; if(!w.history || w.history.length >= 7) return; if(type === 'cheat') { w.cheats++; data.totalFine += 100; if(w.cheats >= 3) w.failed = true; w.history.push('cheat'); } else { w.history.push('success'); } db.set(data); }
        function updateWeekDate(idx, v) { data.weeks[idx].dateRange = v; db.set(data); }
        function updateNote(idx, v) { data.weeks[idx].note = v; db.set(data); }
        function processSettlement() { if(confirm("çµç®—ï¼Ÿ")) { data.settled = true; db.set(data); } }
    </script>
</body>
</html>