<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶è²ç˜¦èº«è¨ˆåŠƒ - å…¨èƒ½ç®¡ç†ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ff6b6b; --success: #51cf66; --warning: #fcc419; --bg: #f8f9fa; --text: #343a40; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1000px; margin: 0 auto; }
        .left-column { flex: 1; min-width: 320px; max-width: 450px; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 10px; }
        .stat-value { font-size: 1.2rem; font-weight: bold; display: block; }
        .rule-card { background: #fff; border-left: 5px solid var(--primary); padding: 20px; border-radius: 10px; position: sticky; top: 20px; }
        .day-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; background: white; }
        .day-dot.success { background-color: var(--success); border-color: var(--success); color: white; }
        .day-dot.cheat { background-color: var(--primary); border-color: var(--primary); color: white; }
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        textarea { width: 100%; height: 50px; margin-top: 8px; border: 1px solid #eee; border-radius: 5px; resize: none; box-sizing: border-box; }
        
        /* ç®¡ç†å“¡å°ˆå€æ¨£å¼ */
        #adminPanel { display: none; background: #212529; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .admin-section { border-bottom: 1px solid #495057; padding-bottom: 15px; margin-bottom: 15px; }
        .admin-input { width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: none; box-sizing: border-box; }
        .lock-icon { text-align: center; color: #adb5bd; cursor: pointer; margin: 40px 0; font-size: 0.8rem; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-column">
            <div class="card">
                <h1>ğŸ« ç˜¦èº«é¦¬ç”²ç·šè¨ˆåŠƒ</h1>
                <div class="dashboard">
                    <div class="stat-box"><span>æœˆåº•é è¨ˆé ˜å–</span><span class="stat-value" id="totalBonus" style="color:var(--success)">NT$ 0</span></div>
                    <div class="stat-box"><span>ç´¯è¨ˆç½°æ¬¾</span><span class="stat-value" id="totalFine" style="color:var(--primary)">NT$ 0</span></div>
                </div>
            </div>
            <div id="app">åŒæ­¥ä¸­...</div>
            <div id="settleArea" style="text-align:center; padding: 10px;">
                <button onclick="processSettlement()" style="background:var(--primary); color:white; width:100%; padding:15px; font-size:1.1rem; border-radius:15px;">ğŸ çµç®—æœ¬æœˆçé‡‘</button>
                <div id="settleResult" style="display:none; margin-top:15px; padding:15px; border-radius:10px; font-weight:bold; white-space: pre-line;"></div>
            </div>
        </div>

        <div style="flex: 0.8; min-width: 300px;">
            <div class="rule-card">
                <h2>ğŸ“œ æ¸›è‚¥ä½œæˆ°å®ˆå‰‡</h2>
                <ul id="ruleList" style="padding-left: 20px; line-height: 1.8;"></ul>
            </div>
            
            <div class="lock-icon" onclick="openAdmin()">ğŸ”’ ç®¡ç†å“¡æ§åˆ¶å°å…¥å£</div>
            
            <div id="adminPanel">
                <h3 style="color:var(--success)">ğŸ› ï¸ ç³»çµ±å¾Œå°è¨­å®š</h3>
                
                <div class="admin-section">
                    <label>å®ˆå‰‡ä¿®æ”¹ (æ¯è¡Œä¸€æ¢):</label>
                    <textarea id="editRules" class="admin-input" style="height:100px;"></textarea>
                </div>

                <div class="admin-section">
                    <label>æ¯é€±çé‡‘ NT$:</label>
                    <input type="number" id="editBonus" class="admin-input">
                </div>

                <div class="admin-section">
                    <label>ä¿®æ”¹å¾Œå°å¯†ç¢¼:</label>
                    <input type="text" id="editPw" class="admin-input">
                    <label>ä¿®æ”¹å¯†ç¢¼æç¤º:</label>
                    <input type="text" id="editHint" class="admin-input">
                </div>

                <button onclick="addNewWeek()" style="background:#4dabf7; color:white; width:100%; margin-bottom:10px;">â• æ–°å¢ä¸€é€±è¨ˆç•«</button>
                <button onclick="saveAdminSettings()" style="background:var(--success); color:white; width:100%;">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
                <button onclick="fullReset()" style="background:var(--primary); color:white; width:100%; margin-top:20px; font-size:0.8rem;">âš ï¸ å…¨éƒ¨æ¸…é™¤é‡æ–°é–‹å§‹</button>
                <button onclick="closeAdmin()" style="background:#666; color:white; width:100%; margin-top:10px;">é—œé–‰å¾Œå°</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA0ihW3ZPIrEHLPay1_psV_qrUn9jqAtuU",
            authDomain: "babyhan-11286.firebaseapp.com",
            databaseURL: "https://babyhan-11286-default-rtdb.firebaseio.com",
            projectId: "babyhan-11286",
            storageBucket: "babyhan-11286.firebasestorage.app",
            messagingSenderId: "972062726412",
            appId: "1:972062726412:web:ef33e8cfb60305f388d129"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('dietDataV3');

        let data = {
            rules: ["æ—©é¤è¦åƒçš„å¥åº·", "ä¸­é¤å¯ä»¥åƒé£½", "åš´ç¦é£²æ–™ä¸‹åˆèŒ¶", "æ™šé¤è¦åƒå¥åº·"],
            weekBonus: 1000,
            password: "520",
            pwHint: "äº¤å¾€ç´€å¿µæ—¥(0520)",
            totalFine: 0,
            settled: false,
            weeks: Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "è¨­å®šæ—¥æœŸ", note: "", history: [] }))
        };

        db.on('value', (s) => { if(s.val()) { data = s.val(); render(); } else { db.set(data); } });

        function render() {
            document.getElementById('ruleList').innerHTML = data.rules.map(r => `<li>${r}</li>`).join('');
            const app = document.getElementById('app');
            app.innerHTML = '';
            let currentBonus = 0;

            data.weeks.forEach((week, index) => {
                if (!week.failed) currentBonus += parseInt(data.weekBonus);
                let historyDots = '';
                for(let i=0; i<7; i++) {
                    const status = week.history ? week.history[i] : undefined;
                    let dotClass = '', dotText = '';
                    if(status === 'success') { dotClass = 'success'; dotText = 'âœ“'; }
                    else if(status === 'cheat') { dotClass = 'cheat'; dotText = 'âœ•'; }
                    historyDots += `<span class="day-dot ${dotClass}">${dotText}</span>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>ç¬¬ ${index + 1} é€±</span>
                        <span style="color:${week.failed ? 'red' : 'green'}">${week.failed ? 'âš ï¸ æ­¸é›¶' : 'ğŸ’° $'+data.weekBonus}</span>
                    </div>
                    <input style="border:none; color:gray; font-size:0.8rem; width:100%; margin:5px 0;" value="${week.dateRange}" onchange="updateWeekDate(${index}, this.value)">
                    <div style="font-size:0.85rem; color:#666; text-align:center;">æœ¬é€±é•è¦ï¼š${week.cheats}/3</div>
                    <div style="margin: 10px 0; display:flex; justify-content:center; gap:5px;">${historyDots}</div>
                    <div class="btn-group">
                        <button style="background:#ebfbee; color:green;" onclick="addStep(${index}, 'success')">âœ… å®Œæˆ</button>
                        <button style="background:#fff5f5; color:red;" onclick="addStep(${index}, 'cheat')">ğŸš¨ å·åƒ</button>
                        <button style="background:#f1f3f5; color:gray; font-size:0.7rem; flex:0.5;" onclick="resetWeek(${index})">é‡ç½®</button>
                    </div>
                    <textarea placeholder="é»æ­¤ç´€éŒ„å·åƒäº†ä»€éº¼..." onchange="updateNote(${index}, this.value)">${week.note || ''}</textarea>
                `;
                app.appendChild(card);
            });

            document.getElementById('totalBonus').innerText = `NT$ ${currentBonus}`;
            document.getElementById('totalFine').innerText = `NT$ ${data.totalFine}`;
            
            const res = document.getElementById('settleResult');
            if(data.settled) {
                res.style.display = 'block';
                res.style.background = currentBonus > 0 ? '#d3f9d8' : '#ffe3e3';
                res.innerText = currentBonus > 0 ? `ğŸ‰ æœ€çµ‚é ˜å–ï¼šNT$ ${currentBonus} \n ğŸ’– ç˜¦èº«æˆåŠŸï¼å»æ‰¾æœ•é ˜è³ï¼` : `ğŸ‘º å…¨è»è¦†æ²’ \n ç½°æ¬¾è¨˜å¾—ç¹³æ¸…ï¼`;
            } else { res.style.display = 'none'; }
        }

        // åŠŸèƒ½é‚è¼¯
        function addStep(idx, type) {
            if(data.settled) return;
            const w = data.weeks[idx];
            if(!w.history) w.history = [];
            if(w.history.length >= 7) return alert("ç´€éŒ„å·²æ»¿");
            if(type === 'cheat') {
                w.cheats++; data.totalFine += 100;
                if(w.cheats >= 3) w.failed = true;
                w.history.push('cheat');
            } else { w.history.push('success'); }
            db.set(data);
        }
        function updateWeekDate(idx, v) { data.weeks[idx].dateRange = v; db.set(data); }
        function updateNote(idx, v) { data.weeks[idx].note = v; db.set(data); }
        function resetWeek(idx) { if(confirm("ç¢ºå®šé‡ç½®æœ¬é€±æ•¸æ“šï¼Ÿ")) { data.weeks[idx] = {cheats:0, failed:false, dateRange:"è¨­å®šæ—¥æœŸ", note:"", history:[]}; db.set(data); } }
        function processSettlement() { if(confirm("ç¢ºå®šè¦çµç®—æœ¬æœˆçé‡‘å—ï¼Ÿ")) { data.settled = true; db.set(data); } }

        // ç®¡ç†å“¡å¾Œå°
        function openAdmin() {
            const pw = prompt(`ç®¡ç†å“¡ç™»å…¥\næç¤ºï¼š${data.pwHint}`);
            if (pw === data.password) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('editRules').value = data.rules.join('\n');
                document.getElementById('editBonus').value = data.weekBonus;
                document.getElementById('editPw').value = data.password;
                document.getElementById('editHint').value = data.pwHint;
            } else if(pw !== null) { alert("å¯†ç¢¼éŒ¯èª¤"); }
        }
        function saveAdminSettings() {
            data.rules = document.getElementById('editRules').value.split('\n').filter(r => r.trim() !== "");
            data.weekBonus = document.getElementById('editBonus').value;
            data.password = document.getElementById('editPw').value;
            data.pwHint = document.getElementById('editHint').value;
            db.set(data);
            alert("è¨­å®šå·²åŒæ­¥é›²ç«¯ï¼");
            closeAdmin();
        }
        function addNewWeek() {
            data.weeks.push({cheats:0, failed:false, dateRange:"æ–°çš„ä¸€é€±", note:"", history:[]});
            db.set(data);
            alert("å·²æ–°å¢ä¸€é€±è¨ˆç•«ï¼");
        }
        function fullReset() {
            if(confirm("âš ï¸ æ³¨æ„ï¼é€™å°‡æ¸…ç©ºæ‰€æœ‰é€²åº¦èˆ‡ç½°æ¬¾ï¼Œé–‹å•Ÿæ–°çš„ä¸€æœˆã€‚ç¢ºå®šå—ï¼Ÿ")) {
                data.totalFine = 0; data.settled = false;
                data.weeks = Array(4).fill().map(() => ({ cheats: 0, failed: false, dateRange: "è¨­å®šæ—¥æœŸ", note: "", history: [] }));
                db.set(data);
                alert("å·²å…¨éƒ¨é‡ç½®ï¼");
            }
        }
        function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; }
    </script>
</body>
</html>